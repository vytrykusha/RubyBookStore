#!/bin/bash
set -e

# Enable jemalloc for reduced memory usage.
if [ -z "${LD_PRELOAD+x}" ] && ls /usr/lib/*/libjemalloc.so.2 > /dev/null 2>&1; then
  export LD_PRELOAD="$(echo /usr/lib/*/libjemalloc.so.2)"
fi

if [ "$1" = "./bin/rails" ] && [ "$2" = "server" ]; then
  echo "==> Preparing database..."
  ./bin/rails db:prepare

  echo "==> Precompiling assets..."
  bundle exec rails assets:precompile

  echo "==> Database and assets ready"
fi

exec "$@"
