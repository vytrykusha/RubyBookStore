<div class="container mt-5">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">üí¨ –ö–Ω–∏–∂–∫–æ–≤–∏–π –ü–æ–º—ñ—á–Ω–∏–∫</h4>
          <small>–†–æ–∑–ø–æ–≤—ñ–¥–∞–π—Ç–µ –ø—Ä–æ —Å–≤–æ—î —É–ª—é–±–ª–µ–Ω–µ —á–∏—Ç–∞–Ω–Ω—è - —è –¥–æ–ø–æ–º–æ–∂—É –≤–∞–º –∑–Ω–∞–π—Ç–∏ –Ω–æ–≤—ñ –∫–Ω–∏–≥–∏!</small>
        </div>
        
        <div class="card-body" id="chat-messages" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
          <!-- –ü–æ—á–∞—Ç–∫–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
          <div class="mb-3">
            <div class="alert alert-info" role="alert">
              üëã –ü—Ä–∏–≤—ñ—Ç! –Ø –∫–Ω–∏–∂–∫–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫. –ó–∞–ø–∏—Ç–∞–π—Ç–µ –º–µ–Ω–µ –ø—Ä–æ –∫–Ω–∏–≥–∏!
            </div>
          </div>
          
          <!-- –ë—É–¥—É—Ç—å –¥–æ–¥–∞—Ç–∏—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
        </div>
        
        <div class="card-footer">
          <form id="chat-form" onsubmit="sendMessage(event)">
            <div class="input-group">
              <input 
                type="text" 
                class="form-control" 
                id="message-input" 
                placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è..." 
                autocomplete="off"
              >
              <button class="btn btn-primary" type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
              <button class="btn btn-outline-secondary" type="button" onclick="clearChat()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let messageCount = 0;

function sendMessage(event) {
  event.preventDefault();
  
  const input = document.getElementById('message-input');
  const message = input.value.trim();
  
  if (!message) return;
  
  // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  addMessage('user', message);
  input.value = '';
  input.focus();
  
  // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –∑–∞–ø–∏—Ç
  fetch('/chat/send_message', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify({ message: message })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      addMessage('bot', data.error, 'error');
    } else {
      addMessage('bot', data.message, data.type);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    addMessage('bot', '–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—å –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.', 'error');
  });
}

function addMessage(role, content, type = 'local') {
  const container = document.getElementById('chat-messages');
  messageCount++;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = 'mb-3';
  
  if (role === 'user') {
    messageDiv.innerHTML = `
      <div class="text-end">
        <span class="badge bg-primary p-2" style="max-width: 70%; word-wrap: break-word;">
          ${escapeHtml(content)}
        </span>
      </div>
    `;
  } else {
    const badgeClass = type === 'error' ? 'bg-danger' : (type === 'api' ? 'bg-success' : 'bg-secondary');
    const typeLabel = type === 'api' ? 'ü§ñ AI' : (type === 'error' ? '‚ùå' : 'üí≠');
    
    messageDiv.innerHTML = `
      <div class="text-start">
        <div style="display: inline-block; background-color: #e9ecef; border-radius: 10px; padding: 10px 15px; max-width: 70%;">
          <small class="d-block text-muted mb-1">${typeLabel} ${type === 'error' ? '–ü–æ–º–∏–ª–∫–∞' : (type === 'api' ? 'AI –í—ñ–¥–ø–æ–≤—ñ–¥—å' : '–õ–æ–∫–∞–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å')}</small>
          <span>${escapeHtml(content)}</span>
        </div>
      </div>
    `;
  }
  
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;
}

function clearChat() {
  if (confirm('–û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —á–∞—Ç—É?')) {
    fetch('/chat/clear', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(() => {
      document.getElementById('chat-messages').innerHTML = `
        <div class="mb-3">
          <div class="alert alert-info" role="alert">
            üëã –ü—Ä–∏–≤—ñ—Ç! –Ø –∫–Ω–∏–∂–∫–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫. –ó–∞–ø–∏—Ç–∞–π—Ç–µ –º–µ–Ω–µ –ø—Ä–æ –∫–Ω–∏–≥–∏!
          </div>
        </div>
      `;
      messageCount = 0;
    });
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>

<style>
#chat-messages {
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.card {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
