<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</h1>
    <%= link_to "‚Üê –ù–∞–∑–∞–¥ –¥–æ –∞–¥–º—ñ–Ω—É", admin_root_path, class: "btn btn-secondary" %>
  </div>

  <!-- KPI Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h5>–í—Å—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h5>
          <h2><%= @total_users %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h5>–í—Å—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω—å</h5>
          <h2><%= @total_orders %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h5>–î–æ—Ö—ñ–¥</h5>
          <h2>‚Ç¥<%= @total_revenue.round(2) %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-dark">
        <div class="card-body">
          <h5>–ó–∞–º–æ–≤–ª–µ–Ω—å —Å—å–æ–≥–æ–¥–Ω—ñ</h5>
          <h2><%= @today_orders %></h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row">
    <!-- Daily Activity Chart -->
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">üìà –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (7 –¥–Ω—ñ–≤)</h5>
        </div>
        <div class="card-body">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Orders Trend -->
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (7 –¥–Ω—ñ–≤)</h5>
        </div>
        <div class="card-body">
          <canvas id="ordersChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Activity by Type -->
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">üéØ –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑–∞ —Ç–∏–ø–∞–º–∏</h5>
        </div>
        <div class="card-body">
          <canvas id="activityTypeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Revenue Trend -->
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">üí∞ –î–æ—Ö—ñ–¥ (7 –¥–Ω—ñ–≤)</h5>
        </div>
        <div class="card-body">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Popular Books -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">‚≠ê –ü–æ–ø—É–ª—è—Ä–Ω—ñ –∫–Ω–∏–≥–∏</h5>
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>–ö–Ω–∏–≥–∞</th>
                <th>–ê–≤—Ç–æ—Ä</th>
                <th>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤</th>
              </tr>
            </thead>
            <tbody>
              <% @popular_books.each do |book| %>
                <tr>
                  <td><strong><%= book.title %></strong></td>
                  <td><%= book.author %></td>
                  <td><span class="badge bg-primary"><%= book.comments_count %></span></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="chart-data"
     data-activity="<%= @daily_activity.to_json %>"
     data-orders="<%= @orders_by_day.to_json %>"
     data-types="<%= @activity_by_type.to_json %>"
     data-revenue="<%= @revenue_by_day.to_json %>">
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const dataBlock = document.getElementById('chart-data');

  const activityData = JSON.parse(dataBlock.dataset.activity);
  const ordersData   = JSON.parse(dataBlock.dataset.orders);
  const typeData     = JSON.parse(dataBlock.dataset.types);
  const revenueData  = JSON.parse(dataBlock.dataset.revenue);

  // --- Activity Chart ---
  if (activityData.length > 0) {
    new Chart(document.getElementById('activityChart'), {
      type: 'line',
      data: {
        labels: activityData.map(d => d.date),
        datasets: [{
          label: '–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å',
          data: activityData.map(d => d.count),
          borderColor: '#007bff',
          backgroundColor: 'rgba(0, 123, 255, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } }
      }
    });
  }

  // --- Orders Chart ---
  if (ordersData.length > 0) {
    new Chart(document.getElementById('ordersChart'), {
      type: 'bar',
      data: {
        labels: ordersData.map(d => d.date),
        datasets: [{
          label: '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è',
          data: ordersData.map(d => d.count),
          backgroundColor: '#28a745'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } }
      }
    });
  }

  // --- Activity Type Chart ---
  if (Object.keys(typeData).length > 0) {
    new Chart(document.getElementById('activityTypeChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(typeData),
        datasets: [{
          data: Object.values(typeData),
          backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8']
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  // --- Revenue Chart ---
  if (revenueData.length > 0) {
    new Chart(document.getElementById('revenueChart'), {
      type: 'bar',
      data: {
        labels: revenueData.map(d => d.date),
        datasets: [{
          label: '–î–æ—Ö—ñ–¥ (‚Ç¥)',
          data: revenueData.map(d => d.revenue),
          backgroundColor: '#17a2b8'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } }
      }
    });
  }

});
</script>
